<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="center">
        <textarea id="input" placeholder="Input coordinates"></textarea><br>
        <button id="button">Parse</button><br><br><br>
        <table id="data_table"></table>
        <button id="download_csv">Download CSV</button>
    </div>
    <script>
        $("button").click(function(){
            var data = $("#input").val();
            $.post("http://127.0.0.1:5000/", {raw_data:data}, function(flask_data) {
                flask_data = flask_data.replace(/'/g, '"')
                data = JSON.parse(flask_data);
                let headers = Object.keys(data[0])
                data_table_string = "<tr> "
                for (let i=0; i<headers.length; i++){
                    data_table_string = data_table_string + "<th>" +headers[i]+ "</th>"
                }
                data_table_string = data_table_string + " </tr> "
                for (let dl=0; dl<data.length; dl++){
                    data_set = data[dl]
                    data_set_headers = Object.keys(data_set)
                    data_set_length = data_set_headers.length
                    data_table_string = data_table_string + " <tr> "
                    
                    for (let dsl=0; dsl<data_set_length; dsl++){
                        data_table_string = data_table_string + "<td>"+ data_set[data_set_headers[dsl]] +"</td>"
                    }
                    
                    data_table_string = data_table_string + " </tr>"
                }
                get_csv(data, headers)
                $("#data_table").html(data_table_string)
            });
        });

        function get_csv(data, headers) {
            const csv_rows = []
            csv_rows.push(headers.join(","));

            for (const row of data){
                const values = headers.map(header => {
                    if (header in row === true){
                        const escaped = (""+row[header]).replace(/"/g, '\\"')
                        return `"${row[header]}"`
                    }
                    else {
                        const empty = " "
                        return `"${empty}"`
                    }
                })
                csv_rows.push(values.join(","))
            }

            const csv_data = csv_rows.join("\n")
            download_csv(csv_data)
        }

        function download_csv(data){
            const blob = new Blob([data], { type: "text/csv"});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.setAttribute("hidden", "");
            a.setAttribute("href", url);
            a.setAttribute("download", "Vietas_dati.csv");
            document.body.appendChild(a);
            $("#download_csv").on("click", function(){
                a.click();
            })
            document.body.removeChild(a);
        }
    </script>
</body>
</html>