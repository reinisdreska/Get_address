<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="center">
        <textarea id="input" placeholder="Input coordinates"></textarea><br>
        <div class="left">
            <input class="file_upload" type="file" name="table_file" id="table_file" accept=".csv"><br>
            <p>Choose lat key<select name="lat" id="lat"><option value=""> Choose lat key</option></select></p>
            <p>Choose lon key<select name="lon" id="lon"><option value=""> Choose lon key</option></select></p>
        </div>
        <label><input type="checkbox" checked="checked" value="REVGEO_valsts">valsts</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_admin_vien">admin_vien</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_terit_vien">terit_vien</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_apdz_vieta">apdz_vieta</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_iela">iela</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_maja">maja</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_index">index</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_korpuss">korpuss</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_vzd_id">vzd_id</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_distance">distance</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_x">x</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_y">y</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_adrese">adrese</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_lat">lat</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_lon">lon</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_starting_lat">starting_lat</label>
        <label><input type="checkbox" checked="checked" value="REVGEO_starting_lon">starting_lon</label>
        <button id="button">Parse</button>
        <button id="create">Create table</button><br><br><br><br><br><br><br>
        <table id="preview_table"></table>
        <table id="data_table"></table>
        <button id="download_csv">Download CSV</button>
    </div>
    <script>
        $("#button").click(function(){
            let checkbox_list = document.querySelectorAll('input[type="checkbox"]:checked')
            let checkbox_array = []
            for (let ch=0; ch<checkbox_list.length; ch++){
                checkbox_array.push(checkbox_list[ch].value)
            }

            if ($("#input").val().length != 0){
                var data = $("#input").val();
                $("#create").click(function(){
                    post_data(data, checkbox_array)
                })
            }

            else {
                const file_raw = Papa.parse(document.getElementById("table_file").files[0],
                {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results){
                        file_table = results.data
                        let keys = Object.keys(file_table[0])

                        preview_table_string = "<tr> "
                        for (let pth=0; pth<5; pth++){
                            preview_table_string = preview_table_string + "<th>" +keys[pth]+ "</th>"
                        }
                        preview_table_string = preview_table_string + " </tr> "
                        for (let ptd=0; ptd<file_table.length; ptd++){
                            preview_set = file_table[ptd]
                            preview_set_headers = Object.keys(preview_set)
                            preview_set_length = preview_set_headers.length
                            preview_table_string = preview_table_string + " <tr> "
                            
                            for (let ptdd=0; ptdd<5; ptdd++){
                                preview_table_string = preview_table_string + "<td>"+ preview_set[preview_set_headers[ptdd]] +"</td>"
                            }
                            
                            preview_table_string = preview_table_string + " </tr>"
                        }

                        $("#preview_table").html(preview_table_string)

                        var lat_key = document.getElementById("lat")
                        lat_key.innerHTML = ""
                        var lon_key = document.getElementById("lon")
                        lon_key.innerHTML = ""

                        var option_array = []
                        for (let dk=0; dk<keys.length; dk++){
                            option_array.push(keys[dk]+ "|" +keys[dk])
                        }

                        for (var option in option_array) {
                            var pair = option_array[option].split("|")
                            var new_option = document.createElement("option")
                            new_option.value = pair[0]
                            new_option.innerHTML = pair[1]
                            lat_key.options.add(new_option)
                        }

                        for (var option in option_array) {
                            var pair = option_array[option].split("|")
                            var new_option = document.createElement("option")
                            new_option.value = pair[0]
                            new_option.innerHTML = pair[1]
                            lon_key.options.add(new_option)
                        }

                        $("#create").click(function(){
                            var lat = lat_key.value
                            var lon = lon_key.value
                            data = String(file_table[0].lat)+ ", " +String(file_table[0].lon)
                            for (let ft=1; ft<file_table.length; ft++){
                                data = data+ "\n" + String(file_table[ft].lat)+ ", " +String(file_table[ft].lon)
                            }
                            post_data(data, checkbox_array, file_table)
                        })
                    }
                })
            }
            
            function post_data(data, checkbox_array, file_table){
                $.post("http://127.0.0.1:5000/", {raw_data:data}, function(flask_data) {
                    flask_data = flask_data.replace(/'/g, '"')
                    raw_json_data = JSON.parse(flask_data)
                    json_data = []
                    for (let arjd=0; arjd<raw_json_data.length; arjd++){
                        raw_json_data_inside = raw_json_data[arjd]
                        var checkbox_dict = {}
                        for (let rjd=0; rjd<checkbox_array.length; rjd++){
                            checkbox_array_inside = checkbox_array[rjd]
                            checkbox_dict[checkbox_array_inside] = raw_json_data_inside[checkbox_array_inside];
                        }
                        json_data.push(checkbox_dict)
                    }

                    if (file_table != undefined){
                        let data =[]
                        for (let d=0; d<file_table.length; d++){
                            let data_dict = {...file_table[d], ...json_data[d]}
                            data.push(data_dict)
                        }
                        create_table(data)
                    }

                    else {
                        create_table(json_data)
                    }
                    
                    function create_table(data){
                        let headers = Object.keys(data[0])
                        data_table_string = "<tr> "
                        for (let i=0; i<headers.length; i++){
                            data_table_string = data_table_string + "<th>" +headers[i]+ "</th>"
                        }
                        data_table_string = data_table_string + " </tr> "
                        for (let dtl=0; dtl<data.length; dtl++){
                            data_set = data[dtl]
                            data_set_headers = Object.keys(data_set)
                            data_set_length = data_set_headers.length
                            data_table_string = data_table_string + " <tr> "
                            
                            for (let dsl=0; dsl<data_set_length; dsl++){
                                data_table_string = data_table_string + "<td>"+ data_set[data_set_headers[dsl]] +"</td>"
                            }
                            
                            data_table_string = data_table_string + " </tr>"
                        }
                        get_csv(data, headers)
                        $("#preview_table").html("")
                        $("#data_table").html(data_table_string)
                    }
                });
            }
        });

        function get_csv(data, headers) {
            const csv_rows = []
            csv_rows.push(headers.join(","));

            for (const row of data){
                const values = headers.map(header => {
                    if (header in row === true){
                        const escaped = (""+row[header]).replace(/"/g, '\\"')
                        return `"${row[header]}"`
                    }
                    else {
                        const empty = " "
                        return `"${empty}"`
                    }
                })
                csv_rows.push(values.join(","))
            }

            const csv_data = csv_rows.join("\n")
            download_csv(csv_data)
        }

        function download_csv(data){
            const blob = new Blob([data], { type: "text/csv"});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.setAttribute("hidden", "");
            a.setAttribute("href", url);
            a.setAttribute("download", "Vietas_dati.csv");
            document.body.appendChild(a);
            $("#download_csv").on("click", function(){
                a.click();
            })
            document.body.removeChild(a);
        }
    </script>
</body>
</html>